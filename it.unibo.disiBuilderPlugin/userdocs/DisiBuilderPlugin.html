<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
	font-size: 93%;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 90%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 90%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	font-size: 90%;
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	font-size: 90%;
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	 
    font-size: 18px;
}
k{
    color: #990000;
	font-weight: bold;
	font-size: 90%;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px;
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #C0F0E0;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;

}
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}
div.remark{
	background-color: #E3F2FD;
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed

}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>

<style>
/* Popup container - can be anything you want */
.popup {
  position: relative;
  display: inline-block;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* The actual popup */
.popup .popuptext {
  visibility: hidden;
  width: 260px;
  background-color: #F3F781;
  color: black;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -80px;
}

/* Popup arrow */
.popup .popuptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

/* Toggle this class - hide and show the popup */
.popup .show {
  visibility: visible;
  -webkit-animation: fadeIn 1s;
  animation: fadeIn 1s;
}

/* Add animation (fade in the popup) */
@-webkit-keyframes fadeIn {
  from {opacity: 0;} 
  to {opacity: 1;}
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity:1 ;}
}
</style>

<script>
// When the user clicks on <div>, open the popup
function myFunction() {
  var popup = document.getElementById("myPopup");
  popup.classList.toggle("show");
}
</script>
    
<head>
   
<title>DisiBuilderPlugin</title></head>
    
<body>
<div id="top">
<h1>LabIss2021 |  DisiBuilderPlugin<font size="5"></font> </h1>
</div>  


<div class="body"> 
<h2>Introduction</h2>
In this work, we create (with Kotlin) a custom Gradle plugin  that provides a set of actor-creation tasks.<br/><br/>
Our work starts with the usage of option 4 of the <tt>gradle init</tt>  command within an empty directory.
(The original result of the command is reported in the project <a href="../../provaPlugin" target="web">C:/.../iss2021Lab/provaPlugin</a>).
<br/><br/>
In our case, we procede as follows:
<h3>Startup</h3>
<ol>
<li>Introduce a new (empty) directory named <ks>C:/.../iss2021Lab/it.unibo.disiBuilderPlugin</ks>. 
The directory <tt>iss2021Lab</tt> must include the sub-directory <a href="../../uniboRepos/maven-repo" target="web"><k>uniboRepos/maven-repo</k></a>  
and the sub-directory <a href="../../unibolibs" target="web"><k>unibolibs</k></a> 
(both copied from <a href="https://github.com/anatali/iss2021Lab" target="web"> https://github.com/anatali/iss2021Lab</a>).<br/>
Within this new directory,  execute the command:
<pre>
gradle init  4  3  2 - -
</pre>
Among the others, this command generates :<br/><br/>
	<ul>
	<li>a file named <tt>plugin/src/main/kotlin/disiBuilderPluginPlugin.kt</tt> that includes a subclass of 
	<tt>Plugin&lt;Project></tt> that registers a 'greeting' task.
	We rename this file as 
	<a href="../plugin/src/main/kotlin/it/unibo/disiBuilderPlugin/disiBuilderPlugin.kt" target="web"><ks>disiBuilderPlugin</ks></a>
	(and change the plugin <tt>implementationClass</tt> in <a href="../plugin/buildGradle.kt" target="web"><ks>plugin/buildGradle.kt</ks></a>). 
	<hr/>
	The class <a href="../plugin/src/main/kotlin/it/unibo/disiBuilderPlugin/disiBuilderPlugin.kt" target="web"><ks>disiBuilderPlugin</ks></a>
	includes the registration of our generation-tasks (e.g. <tt>buildDisiTest</tt>, ..., <tt>buildQakSystem</tt>).<br/>
	Our tasks (see section <a href="#disitasks">Tasks</a>) are mainly defined as subclasses of 
	<a href="https://docs.gradle.org/current/dsl/org.gradle.api.DefaultTask.html"  target="web">org.gradle.api.DefaultTask</a>
	under the package named 
	<a href="../plugin/src/main/kotlin/unibo/disi/builder" target="web"><ks>unibo.disi.builder</ks></a>.
	<br/><br/>
	</li>
	<li>files for   
	<a href="../plugin/src/test/kotlin/it/unibo/disiBuilderPlugin/ItUniboDisiBuilderPluginPluginTest.kt" target="web">testing the plugin</a> 
	and for 
	<a href="../plugin/src/functionalTest/kotlin/it/unibo/disiBuilderPlugin/ItUniboDisiBuilderPluginPluginFunctionalTest.kt" target="web">testing the functional behavior</a> 
	 that we properly change according to our needs.<br/><br/>
	</li>
	<li>a file <a href="../plugin/build.gradle.kts" target="web">plugin/build.gradle.kts</a>  in which we
<kc>ADD</kc> some sentence and <kc>CHANGE</kc> some others.</li>

	</ul>
</li>

</ol>
 
<h3>Changing <a href="../plugin/build.gradle.kts" target="web">plugin/build.gradle.kts</a></h3> 

We add commands (see the code):
<ol>
<li>to publish the plugin in the <a href="../../uniboRepos/maven-repo" target="web"><k>uniboRepos/maven-repo</k></a> </li>
<li>to exploit the DISI
<a href="http://amsacta.unibo.it/5450/7/tuprolog-guide.pdf" target="web"><k>tuProlog</k></a> library
for our model-based code-generation tasks. In fact, the models of our systems are written as a set of Prolog facts. 
An example is given in section <a href="#kcodegen">Generation of Kotlin code</a>.

</li> 
<li>to properly define our plugin with name <k>unibo.disi.builder</k> and implementation class
<a href="../plugin/src/main/kotlin/it/unibo/disiBuilderPlugin/disiBuilderPlugin.kt" target="web"><ks>it.unibo.disiBuilderPlugin.disiBuilderPlugin</ks></a>
</li>
</ol>


<h2>Defining code-generation tasks</h2>
The plugin implementation class
<a href="../plugin/src/main/kotlin/it/unibo/disiBuilderPlugin/disiBuilderPlugin.kt" target="web"><ks>it.unibo.disiBuilderPlugin.disiBuilderPlugin</ks></a>
registers in the project a set of code-generation tasks.
<h4 id="disitasks">The Tasks</h4>
 <table style="width:98%">
<tbody>	
<tr>
<td style="width:35%" >
<ks><k>buildDisiTest</k></ks><br/>
<ks><k>projectInfo </k></ks>
</td>
<td>Tasks used for fast testing
</td>
</tr>

<tr>
<td>
<ks><k>buildActorDisi</k>  --model &ltmodelName></ks>
</td>
<td>Generates Kotlin code for actors, by starting from the given <tt>&ltmodelName></tt> written as a set of Prolog facts. For example:
<pre>
system( demo0, msgdriven ).	  <kc>//alternative: <ks>system( demo0, <k>fsm</k> )</ks>.</kc>
context(ctxdemo0, "localhost",  "TCP", "8095").
qactor( demo0, ctxdemo0, _).
</pre>
The generated code requires the DISI library  <ks>it.unibo.qakactor-2.4.jar</ks>
stored in  <a href="../../unibolibs" target="web">unibolibs</a>
</td>
</tr>

<tr>
<td>
<ks><k>buildQakSystem</k>  --sysname &ltsystemName> </ks>

</td>
<td>Generates an example of a model written in the
<a href="../../it.unibo.qakactor/userDocs/LabQakIntro2020.html" target="web">custom language Qak</a>. <br/>
Once generated within an Eclipse-DSL workspace (with the <a href="../../it.unibo.issLabStart/resources/plugins" target="web">DISI-plugins</a>
stored in <tt>it.unibo.issLabStart/resources</tt>), 
this model generates, in its turn, Kotlin code for a distributed system with name <tt>&ltsystemName></tt>.

 

</td>
</tr>




 </tbody>
</table>
<h3 id="kcodegen">Generation of Kotlin code</h3>
The set of resources used to generate actor-driven or actor-based systems used by the
<a href="../plugin/src/main/kotlin/it/unibo/disiBuilderPlugin/disiBuilderPlugin.kt" target="web"><ks>disiBuilderPlugin</ks></a>
starts from the user-defined gradle-task of class 
<a href="../plugin/src/main/kotlin/unibo/disi/builder/BuildActorTask.kt" target="web"><ks>unibo.disi.builder.BuildActorTask.kt</ks></a>,
that is registered with the name <k>buildActorDisi</k>. 
<br/><br/>
This task takes a system model given as input-argument named  <ks>model</ks> and
generates the skeleton code for the actors included in the give  <tt>system model</tt>.<br/><br/>

The generation process is defined in the operation <tt>genCodeFromModel</tt> of the Kotlin object
<a href="../plugin/src/main/kotlin/unibo/disi/builder/Generator.kt" target="web"><ks>unibo.disi.builder.Generator.kt</ks></a> 
that works as follows (see the code):<br/><br/>

<ol>
<li>generates - if it does not exixts -  a directory <ks>src</ks> in the user-workspace;</li>
<li>generates, in the main directory of the user-workspace, a file <ks>build.gradle</ks> that defines the dependencies required
to compile the  code generated in the user-workspace <ks>src</ks> directory;</li>

<li>generates, in the main directory of the user-workspace, a file named <ks>sysRules.pl</ks> that includes a set of Prolog-rules 
that will be used to facilitate the code-generation process;
</li>

<li>loads the  <tt>system model</tt> and the <tt>sysRules</tt> in a local Prolog theory name <ks>sysKb</ks></li>

<li>checks if the code to be generated must follow the <k>msgdriven</k> or the <k>fsm</k> style.<br/> 
If the specified behavior is <tt>msgdriven</tt>, it delegates the code-generation job to 
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorMsgDrivenSystem.kt" target="web">
<ks>GeneratorMsgDrivenSystem.kt</ks></a>.<br/>
If the specified behavior is <tt>fsm</tt>, it delegates the code-generation job to 
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorFsmSystem.kt" target="web">
<ks>GeneratorFsmSystem.kt</ks></a>.
 </li>
 
</ol>

<h4>Message-driven code</h4>
The code-generator <a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorMsgDrivenSystem.kt" target="web">
<ks>GeneratorMsgDrivenSystem.kt</ks></a> delegates to the object
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorActorsInContext.kt" target="web">
<ks>GeneratorActorsInContext.kt</ks></a> the following jobs: 


<ol>
<li>call the object 
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorActorMsgDrivenCode.kt" target="web">GeneratorActorMsgDrivenCode</a>
to generate (in <k>msgdriven</k> style) the skeleton code of the actors
</li>
<li>generate a new directory for the system and a new file in it with the generated code</li>
</ol>
Example:
<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
The file <tt>demo0.pl</tt> defines the model
<pre>
system( demo0, msgdriven ).

context(ctxdemo0, "localhost",  "TCP", "8095").
 qactor( sender,   ctxdemo0, _).
 qactor( receiver, ctxdemo0, _).
</pre> 

</td>
<td>The command <tt>gradle buildActorDisi --model demo0</tt> produces: 
<pre>
src	
   it.unibo.demo0
      demo0.kt
</pre>
<m>
The generated file <tt>it.unibo.demo0.demo0.kt</tt> includes a main program.
It can be executed by importing Kotlin coroutines and channels
<pre>
import kotlinx.coroutines.*
import kotlinx.coroutines.channels.actor
import kotlinx.coroutines.channels.SendChannel
</pre></m>
</td>
</tr>


 </tbody>
</table>

<h4>Finite state-machine code</h4>
The code-generator <a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorFsmSystem.kt" target="web">
<ks>GeneratorFsmSystem.kt</ks></a> collects all the contexts declared in the model and, for each context,  calls the object
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorCtx.kt" target="web"><ks>GeneratorCtx.kt</ks></a>  that:
<ol>
<li>generates a main program for the context </li>
<li>generates  (by calling the object 
<a href="../plugin/src/main/kotlin/unibo/disi/builder/GeneratorActorFsmCode.kt" target="web">GeneratorActorFsmCode</a>)
the skeleton  code (in <k>finite state machine</k> style) for all the actors of that context and 
generates a new directory for each actor that includes a new file with the actor-code.

</li>
</ol>
Example:
<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
The file <tt>demo1.pl</tt> defines the model
<pre>
system( demo1, fsm  ).

context(ctxdemo1, "localhost",  "TCP", "8095").	
qactor( sender,   ctxdemo1, "it.unibo.sender.sender").		
qactor( receiver, ctxdemo1, "it.unibo.receiver.receiver").
<kc>//it.unibo.sender.sender     is the generated actor class</kc>
<kc>//it.unibo.receiver.receiver is the generated actor class</kc>
</pre> 
<m>
The model must now include the names of the generated actor class in order to make the generated code executable.
In fact the main program <tt>Main_ctxdemo1.kt</tt> generates the system by consulting the model and by 
using the Java reflection mechanism to create the instances of the actors.
</m>
</td>
<td>The command <tt>gradle buildActorDisi --model demo1</tt> produces: 
<pre>
src	
   it.unibo
     ctxdemo1
        Main_ctxdemo1.kt
     receiver	
        receiver.kt
     sender
        sender.kt
</pre>
<m>
The main program <tt>it.unibo.ctxdemo1.Main_ctxdemo1.kt</tt> requires the 
<tt>it.unibo.kactor.QakContext</tt>  deployed in the DISI library <tt>it.unibo.qakactor-2.4.jar</tt>
stored in  <a href="../../unibolibs" target="web">unibolibs</a>.
</m>
</td>
</tr>
 
 </tbody>
</table>


<h3>Generation of Qak code</h3>
  
<br/>



<table style="width:98%">
 
<tr>
<td style="width:70%" >
The generator code is defined in <br/>
<a href="../buildSrc/src/main/kotlin/unibo/disi/builder/utils.kt" target="web">
buildSrc/src/main/kotlin/unibo/disi/builder/utils.kt</a>
<br/><br/>
The generator code is used to define a custom Gradle plugin:<br/>
<a href="../buildSrc/src/main/kotlin/unibo/disi/builder/DisiBuilderPlugin.kt" target="web">
buildSrc/src/main/kotlin/unibo/disi/builder/DisiBuilderPlugin.kt</a>
<br/><br/>
The plugin is created in
<a href="../buildSrc/build.gradle.kts" target="web">buildSrc/build.gradle.kts</a><br/>
and published 
<br/><br/>
The plugin is used in
<a href="../app/build.gradle.kts" target="web">app/build.gradle.kts</a>

<pre>
project.plugins.forEach() {
    println( it )
}
</pre>
</td>
<td>
</td>
</tr>
 
</table>
Open Eclipse and import existing project <kc>C:\...\provaDisiBuilder</kc>. We will use Eclipse mainly for its editor capabilities.<br/>

Open IntelliJ and import (as a Gradle project) existing project <kc>C:\...\provaDisiBuilder</kc>.<br/>

Open prova0.qak (convert in Xtext)<br/>

Add Kotlin nature to the project<br/>

Execute <kc>C:\...\provaDisiBuilder\src\it\unibo\ctxprova0\MainCtxprova0.kt</kc>

<!--
See https://proandroiddev.com/stop-using-gradle-buildsrc-use-composite-builds-instead-3c38ac7a2ab3
-->



<h2>Example of an user project</h2>
https://docs.gradle.org/current/userguide/init_scripts.html
<pre>
In  <kc>C:\...\provaDisiBuilder</kc> execute:
gradle init  2  4  1  2 - -
</pre>

Include in <kc>C:\...\provaDisiBuilder\settings.gradle.kts</kc>
 <pre>
pluginManagement {
    println("SETTINGS pluginManagement ...")
    repositories {
        maven(url = "../uniboRepos/maven-repo")       
        flatDir { dirs("../unibolibs") } //REQUIRED FOR THE unibo plugins
        gradlePluginPortal()
    }
}
</pre>

Include in <kc>C:\...\provaDisiBuilder\settings.gradle.kts</kc>
 <pre>
plugins {
     ...
  	id("unibo.disi.builder") version "1.0"
}
</pre>

Execute
<pre>
gradle -q buildQakSystem  --sysname prova0
</pre>



<h2>CI</h2>
<pre>
 
</pre> 

<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
 

</td>
<td>
</td>
</tr>
 </tbody>
</table>
 

<br/><br/>
</div>
 
<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI  
</div> 
</body>
</html>